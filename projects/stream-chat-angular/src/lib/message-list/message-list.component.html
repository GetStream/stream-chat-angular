@if (
  lastReadMessageId &&
  isUnreadNotificationVisible &&
  openMessageListAt === "last-message" &&
  displayUnreadSeparator
) {
  <ng-container
    *ngTemplateOutlet="
      customnewMessagesNotificationTemplate ||
        defaultUnreadMessagesNotification;
      context: {
        unreadCount: unreadCount,
        onDismiss: messageNotificationDismissClicked,
        onJump: messageNotificationJumpClicked,
      }
    "
  />
}
<ng-template
  #defaultUnreadMessagesNotification
  let-unreadCount="unreadCount"
  let-onDismiss="onDismiss"
  let-onJump="onJump"
>
  <div
    class="str-chat__unread-messages-notification"
    data-testid="unread-messages-notification"
  >
    <button
      data-testid="unread-messages-notification-jump-to-message"
      (click)="onJump()"
    >
      @if (unreadCount > 0 && !hideUnreadCountForNotificationAndIndicator) {
        {{
          (unreadCount === 1
            ? "streamChat.\{\{count\}\} unread message"
            : "streamChat.\{\{count\}\} unread messages"
          ) | translate: { count: unreadCount }
        }}
      } @else {
        {{ "streamChat.Unread messages" | translate }}
      }
    </button>
    <button
      data-testid="unread-messages-notification-dismiss"
      (click)="onDismiss()"
    >
      <stream-icon-placeholder icon="close" />
    </button>
  </div>
</ng-template>
<div #scrollContainer data-testid="scroll-container" class="str-chat__list">
  @if (mode === "main" && isEmpty && emptyListTemplate) {
    <ng-container *ngTemplateOutlet="emptyListTemplate" />
  }
  <div class="str-chat__reverse-infinite-scroll str-chat__message-list-scroll">
    <ul class="str-chat__ul">
      @if (mode === "thread" && parentMessage) {
        <li
          #parentMessageElement
          data-testid="parent-message"
          class="str-chat__parent-message-li"
        >
          <ng-container
            *ngTemplateOutlet="
              messageTemplateContainer;
              context: { message: parentMessage, index: 'parent' }
            "
          />
          <div data-testid="reply-count" class="str-chat__thread-start">
            {{parentMessage.reply_count === 1 ? ('streamChat.1 reply' | translate) : ('streamChat.{{ replyCount }}
            replies' | translate:replyCountParam)}}
          </div>
        </li>
      }
      @if (mode === "thread" && isEmpty && emptyListTemplate) {
        <ng-container *ngTemplateOutlet="emptyListTemplate" />
      }
      @if (
        ((loadingState === "loading-top" && direction === "bottom-to-top") ||
          (loadingState === "loading-bottom" &&
            direction === "top-to-bottom")) &&
        displayLoadingIndicator
      ) {
        <stream-loading-indicator-placeholder
          data-testid="top-loading-indicator"
        />
      } @else {
        <ng-container *ngTemplateOutlet="loadingIndicatorPlaceholder" />
      }
      @if (messages$ | async; as messages) {
        @for (
          message of messages;
          track message.id;
          let i = $index;
          let isFirst = $first;
          let isLast = $last
        ) {
          @if (isFirst) {
            <ng-container
              *ngTemplateOutlet="
                dateSeparator;
                context: {
                  date: message.created_at,
                  parsedDate: parseDate(message.created_at),
                }
              "
            />
          }
          <li
            tabindex="0"
            data-testclass="message"
            class="str-chat__li str-chat__li--{{ groupStyles[i] }}"
            id="{{ message.id }}"
          >
            <ng-container
              *ngTemplateOutlet="
                messageTemplateContainer;
                context: { message: message, index: i }
              "
            />
          </li>
          @if (
            (lastReadMessageId === message?.id &&
              direction === "bottom-to-top") ||
            (direction === "top-to-bottom" &&
              lastReadMessageId === messages[i + 1]?.id)
          ) {
            @if (displayUnreadSeparator) {
              <li
                id="stream-chat-new-message-indicator"
                data-testid="new-messages-indicator"
                class="str-chat__li str-chat__unread-messages-separator-wrapper"
              >
                <ng-container
                  *ngTemplateOutlet="
                    customnewMessagesIndicatorTemplate ||
                      defaultNewMessagesIndicator;
                    context: { unreadCount: unreadCount }
                  "
                />
              </li>
            }
          }
          @if (isNextMessageOnSeparateDate[i]) {
            <ng-container
              *ngTemplateOutlet="
                dateSeparator;
                context: {
                  date: messages[i + 1].created_at,
                  parsedDate: parseDate(messages[i + 1].created_at),
                }
              "
            />
          }
        }
      }
      @if (
        ((loadingState === "loading-bottom" && direction === "bottom-to-top") ||
          (loadingState === "loading-top" && direction === "top-to-bottom")) &&
        displayLoadingIndicator
      ) {
        <stream-loading-indicator-placeholder
          data-testid="bottom-loading-indicator"
        />
      } @else {
        <ng-container *ngTemplateOutlet="loadingIndicatorPlaceholder" />
      }
      <ng-template #loadingIndicatorPlaceholder>
        <div class="str-chat__loading-indicator-placeholder"></div>
      </ng-template>
    </ul>
    <ng-template #defaultTypingIndicator let-usersTyping$="usersTyping$">
      <!-- eslint-disable-next-line @angular-eslint/template/no-any -->
      @if ($any(usersTyping$ | async); as users) {
        @if (users.length > 0) {
          <div
            data-testid="typing-indicator"
            class="str-chat__typing-indicator str-chat__typing-indicator--typing"
          >
            <div class="str-chat__typing-indicator__dots">
              <span class="str-chat__typing-indicator__dot"></span>
              <span class="str-chat__typing-indicator__dot"></span>
              <span class="str-chat__typing-indicator__dot"></span>
            </div>
            <div
              data-testid="typing-users"
              class="str-chat__typing-indicator__users"
            >
              {{
                users.length === 1
                  ? ("streamChat.user is typing"
                    | translate: { user: getTypingIndicatorText(users) })
                  : ("streamChat.users are typing"
                    | translate: { users: getTypingIndicatorText(users) })
              }}
            </div>
          </div>
        }
      }
    </ng-template>
    <ng-container
      *ngTemplateOutlet="
        typingIndicatorTemplate || defaultTypingIndicator;
        context: getTypingIndicatorContext()
      "
    />
  </div>
</div>
<div class="str-chat__jump-to-latest-message">
  @if (isUserScrolled && isJumpToLatestButtonVisible) {
    <button
      data-testid="scroll-to-latest"
      class="str-chat__message-notification-scroll-to-latest str-chat__message-notification-scroll-to-latest-right str-chat__circle-fab"
      (keyup.enter)="jumpToLatestMessage()"
      (click)="jumpToLatestMessage()"
    >
      <stream-icon
        class="str-chat__jump-to-latest-icon str-chat__circle-fab-icon"
        [icon]="direction === 'bottom-to-top' ? 'arrow-down' : 'arrow-up'"
      />
      @if (newMessageCountWhileBeingScrolled > 0) {
        <div
          class="str-chat__message-notification str-chat__message-notification-scroll-to-latest-unread-count str-chat__jump-to-latest-unread-count"
        >
          {{ newMessageCountWhileBeingScrolled }}
        </div>
      }
    </button>
  }
</div>

<ng-template #messageTemplateContainer let-message="message" let-index="index">
  <ng-template
    #defaultMessageTemplate
    let-messageInput="message"
    let-isLastSentMessage="isLastSentMessage"
    let-enabledMessageActions="enabledMessageActions"
    let-mode="mode"
    let-isHighlighted="isHighlighted"
    let-scroll$="scroll$"
  >
    <stream-message
      [message]="messageInput"
      [isLastSentMessage]="isLastSentMessage"
      [enabledMessageActions]="enabledMessageActions"
      [mode]="mode"
      [isHighlighted]="isHighlighted"
      [scroll$]="scroll$"
    />
  </ng-template>
  <ng-container
    *ngTemplateOutlet="
      messageTemplate || defaultMessageTemplate;
      context: {
        message: message,
        isLastSentMessage: !!(
          lastSentMessageId && message?.id === lastSentMessageId
        ),
        enabledMessageActions: enabledMessageActions,
        mode: mode,
        isHighlighted: message?.id === highlightedMessageId,
        scroll$: scroll$,
      }
    "
  />
</ng-template>

<ng-template #dateSeparator let-date="date" let-parsedDate="parsedDate">
  @if (displayDateSeparator) {
    <ng-container
      *ngTemplateOutlet="
        customDateSeparatorTemplate || defaultDateSeparator;
        context: {
          date: date,
          parsedDate: parsedDate,
        }
      "
    />
  }

  <ng-template
    #defaultDateSeparator
    let-date="date"
    let-parsedDate="parsedDate"
  >
    <div data-testid="date-separator" class="str-chat__date-separator">
      @if (
        dateSeparatorTextPos === "right" || dateSeparatorTextPos === "center"
      ) {
        <hr class="str-chat__date-separator-line" />
      }
      <div class="str-chat__date-separator-date">
        {{ parsedDate }}
      </div>
      @if (
        dateSeparatorTextPos === "left" || dateSeparatorTextPos === "center"
      ) {
        <hr class="str-chat__date-separator-line" />
      }
    </div>
  </ng-template>
</ng-template>

<ng-template #defaultNewMessagesIndicator let-unreadCount="unreadCount">
  <div class="str-chat__unread-messages-separator">
    @if (unreadCount > 0 && !hideUnreadCountForNotificationAndIndicator) {
      {{
        (unreadCount === 1
          ? "streamChat.\{\{count\}\} unread message"
          : "streamChat.\{\{count\}\} unread messages"
        ) | translate: { count: unreadCount }
      }}
    } @else {
      {{ "streamChat.Unread messages" | translate }}
    }
  </div>
</ng-template>
