<div
  class="str-chat__message-attachment__voice-recording-widget"
  data-testid="voice-recording-widget"
  [class.str-chat__message-attachment__voice-recording-widget--error]="isError"
>
  <!-- Empty event handlers to trigger change detection -->
  <audio
    #audioElement
    (play)="(null)"
    (pause)="(null)"
    (ended)="(null)"
    (error)="isError = true"
    (abort)="isError = true"
  >
    <source
      data-testid="audio-source"
      [src]="attachment?.asset_url"
      [type]="attachment?.mime_type"
    />
  </audio>
  <button
    class="str-chat__message-attachment-audio-widget--play-button"
    data-testid="play-button"
    (click)="togglePlay()"
  >
    <stream-icon-placeholder [icon]="audioElement?.paused ? 'play' : 'pause'" />
  </button>
  <div class="str-chat__message-attachment__voice-recording-widget__metadata">
    <div class="str-chat__message-attachment-voice-recording-widget--first-row">
      <div
        class="str-chat__message-attachment__voice-recording-widget__title"
        data-testid="voice-recording-title"
        [title]="attachment?.title"
      >
        {{ attachment?.title }}
      </div>
    </div>

    @if (isError) {
      <div
        class="str-chat__message-attachment__voice-recording-widget__error-message"
      >
        <stream-icon-placeholder icon="error" />
        <span data-testid="error-message">{{
          "streamChat.Error playing audio" | translate
        }}</span>
      </div>
    } @else {
      <div
        class="str-chat__message-attachment__voice-recording-widget__audio-state"
      >
        <div
          class="str-chat__message-attachment__voice-recording-widget__timer"
        >
          @if (!!attachment?.duration) {
            <span data-testid="duration">
              {{
                secondsElapsed > 0 || !audioElement.paused
                  ? secondsElapsedFormatted
                  : durationFormatted
              }}</span
            >
          } @else {
            <span
              class="str-chat__message-attachment-file--item-size"
              data-testid="file-size-indicator"
            >
              {{ fileSize }}
            </span>
          }
        </div>
        @if (attachment?.waveform_data && attachment?.duration) {
          <stream-voice-recording-wavebar
            [waveFormData]="attachment?.waveform_data || []"
            [duration]="attachment?.duration"
            [audioElement]="audioElement"
          />
        }
      </div>
    }
  </div>
  <div
    class="str-chat__message-attachment__voice-recording-widget__right-section"
  >
    @if (!audioElement?.paused) {
      <button
        class="str-chat__message_attachment__playback-rate-button"
        data-testid="playback-rate-button"
        (click)="setPlaybackRate()"
      >
        {{ audioElement?.playbackRate | number: "1.1-1" }}x
      </button>
    } @else {
      <stream-icon-placeholder
        class="str-chat__attachment-type-icon"
        icon="audio-file"
      />
    }
  </div>
</div>
